<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f24" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <link rel="icon" href="./icon-192.png" sizes="192x192">
  <title>Games Bucket List</title>
  <style>
    :root { --bg:#0f1220; --card:#181c2f; --ink:#e8ebff; --ink-dim:#b9c0ff; --accent:#8aa0ff; --accent-2:#53d6b6; --danger:#ff6b6b; --muted:#2a2f4a; --radius:16px; --highlight:rgba(138,160,255,.12); }
    html,body{height:100%} html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:radial-gradient(1200px 800px at 100% 0%,#1b2140,#0f1220);color:var(--ink);display:flex;flex-direction:column;align-items:center;overflow-x:hidden}
    .wrap{width:min(900px,96vw);padding:16px 0 200px}
    h1{font-size:20px;letter-spacing:.2px;margin:8px 6px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:0 6px 10px;width:100%;max-width:min(900px,96vw)}
    .topbar .hint{color:var(--ink-dim);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #252a44;border-radius:var(--radius);padding:12px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .inputs{display:grid;grid-template-columns:1fr 90px 72px;gap:8px}
    .inputs input[type=text], .inputs input[type=number]{font-size:16px; padding:10px 10px; border-radius:12px; border:1px solid #2a3156; background:#151a36; color:var(--ink); outline:none;}
    .btn{cursor:pointer;user-select:none;font-weight:700;border-radius:12px;border:1px solid #2a325a;padding:8px 10px;font-size:14px;background:#0f1433;color:var(--ink)}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#5f78ff); color:#0b0f24; border:none; box-shadow:0 4px 16px rgba(95,120,255,.35)}
    .btn.small{padding:6px 8px;font-size:12px;border-radius:10px}
    .row{display:grid;grid-template-columns:22px 1fr 78px 78px;align-items:center;gap:8px;padding:10px;border-radius:12px;background:#151a36;border:1px solid #262c4f;touch-action:none}
    .row.active{background:var(--highlight);border-color:#3b468a}
    .drag{width:22px;height:22px;border-radius:6px;border:1px dashed #3a4272;display:grid;place-items:center;cursor:grab;color:#8892c7;font-size:14px;user-select:none}
    .drag:active{cursor:grabbing}
    .title{font-size:16px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .hours{font-size:16px;justify-self:end}
    .toggleActive{display:inline-flex;align-items:center;gap:6px;justify-self:end}
    .switch{position:relative;width:44px;height:26px;background:#0e1331;border:1px solid #2b3260;border-radius:26px;cursor:pointer}
    .switch::after{content:"";position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#3a4272;transition:transform .18s ease}
    .switch.on{background:#153243;border-color:#2a6a5d}
    .switch.on::after{background:#53d6b6;transform:translateX(18px)}
    .label{display:none}
    .sectionLabel{margin:10px 4px 4px;color:var(--ink-dim);font-size:12px;letter-spacing:.2px}
    .empty{color:var(--ink-dim);text-align:center;padding:16px;border:1px dashed #31375b;border-radius:12px;background:#0f1433}
    .list{display:grid;gap:8px}
    .footerBar{position:fixed;left:0;right:0;bottom:0;display:grid;gap:6px;padding:8px 12px;background:rgba(12,16,36,.8);backdrop-filter:blur(10px);border-top:1px solid #262c4f}
    .sumCard{width:min(900px,96vw);margin:0 auto;display:grid;grid-template-columns:1fr auto;align-items:center}
    .sumText{font-size:14px;color:var(--ink-dim)}
    .sumValue{font-size:18px;font-weight:900}
    .planCard{width:min(900px,96vw);margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .planInput{display:flex;align-items:center;gap:8px;color:var(--ink-dim);font-size:14px}
    .planInput input{width:90px;font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #2a3156;background:#151a36;color:var(--ink)}
    .planValue{font-size:16px;font-weight:700}
    .bulk{width:min(900px,96vw);margin:0 auto;display:none;grid-template-columns:1fr auto auto;align-items:center;gap:8px}
    .bulk.show{display:grid}
    .checkbox{display:none;width:20px;height:20px;border-radius:6px;border:2px solid #3a4272;cursor:pointer}
    .checkbox.show{display:block}
    .hoursInputInline{width:80px}
    @media (max-width:420px){
      .inputs{grid-template-columns:1fr 80px 64px}
      .row{grid-template-columns:20px 1fr 70px 70px}
      .planInput input{width:80px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Games Bucket List</h1>
    <div style="display:flex; align-items:center; gap:6px;">
      <button class="btn small" id="editToggle">Edit</button>
      <div class="hint">Enter adds • Drag handle to reorder</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="inputs">
        <input id="titleInput" type="text" placeholder="Game title" autocomplete="off" />
        <input id="hoursInput" type="number" placeholder="Hours" min="0" step="0.5" inputmode="decimal" enterkeyhint="done" />
        <button class="btn primary small" id="addBtn">Add</button>
      </div>
      <div class="sectionLabel">Active</div>
      <div id="listActive" class="list"></div>
      <div class="sectionLabel">Inactive</div>
      <div id="listInactive" class="list"></div>
      <div id="empty" class="empty" style="display:none">Nothing here yet. Add games above.</div>
    </div>
  </div>

  <div class="footerBar">
    <div class="sumCard">
      <div class="sumText"><span id="activeCount">0</span> active • Total active hours</div>
      <div class="sumValue" id="sumHours">0</div>
    </div>
    <div class="planCard">
      <div class="planInput">
        <label for="dailyHours">Daily</label>
        <input id="dailyHours" type="number" min="0" step="0.5" placeholder="h/day" inputmode="decimal" />
      </div>
      <div class="planValue" id="etaText">≈ 0 days</div>
    </div>
    <div class="bulk" id="bulkBar">
      <div class="hint"><span id="selCount">0</span> selected</div>
      <button class="btn small" id="bulkEditBtn" disabled>Edit</button>
      <button class="btn danger small" id="bulkDeleteBtn" disabled>Delete</button>
      <button class="btn small" id="exportBtn">Export</button>
      <button class="btn small" id="importBtn">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'gameBucketList.data';
  const DAILY_KEY = 'gameBucketList.daily';
  const APP_VERSION = 'v9';

  let items = [];
  let editMode = false;

  const $ = sel => document.querySelector(sel);
  const listA = $('#listActive');
  const listI = $('#listInactive');
  const emptyEl = $('#empty');
  const sumEl = $('#sumHours');
  const activeCountEl = $('#activeCount');
  const selCountEl = $('#selCount');
  const titleIn = $('#titleInput');
  const hoursIn = $('#hoursInput');
  const addBtn = $('#addBtn');
  const bulkBar = $('#bulkBar');
  const bulkEditBtn = $('#bulkEditBtn');
  const bulkDeleteBtn = $('#bulkDeleteBtn');
  const exportBtn = $('#exportBtn');
  const importBtn = $('#importBtn');
  const importFile = $('#importFile');
  const dailyIn = $('#dailyHours');
  const etaText = $('#etaText');
  const editToggle = $('#editToggle');

  function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ version: APP_VERSION, items })); }
  function load(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) { items = []; return; }
      const parsed = JSON.parse(raw);
      items = (parsed.items || []).map((x,i)=> ({ id:x.id||uid(), title:x.title||'', hours:Number(x.hours)||0, active: !!x.active, selected: !!x.selected, order: Number.isFinite(x.order)? x.order : i }));
    } catch(e){ items = []; }
  }

  function normalizeOrder(group){
    const arr = items.filter(x=>x.active===group).sort((a,b)=> (a.order??0) - (b.order??0));
    arr.forEach((x,idx)=> x.order = idx);
  }

  function render(){
    const active = items.filter(x=>x.active).sort((a,b)=> (a.order??0)-(b.order??0));
    const inactive = items.filter(x=>!x.active).sort((a,b)=> (a.order??0)-(b.order??0));

    listA.innerHTML = ''; listI.innerHTML = '';
    emptyEl.style.display = (active.length + inactive.length)===0 ? 'block' : 'none';

    const buildRow = (item)=>{
      const row = document.createElement('div'); row.className='row' + (item.active ? ' active' : ''); row.dataset.id=item.id;

      const drag = document.createElement('div'); drag.className='drag'; drag.textContent='⋮'; drag.title='Drag to reorder';

      const title = document.createElement('div'); title.className='title'; title.textContent=item.title; title.title='Double-tap to edit';
      title.addEventListener('dblclick', ()=> startEditTitle(title, item));

      const hours = document.createElement('div'); hours.className='hours'; hours.textContent = formatHours(item.hours);
      hours.title='Double-tap to edit'; hours.addEventListener('dblclick', ()=> startEditHours(hours, item));

      const activeWrap = document.createElement('div'); activeWrap.className='toggleActive';
      const switchEl = document.createElement('div'); switchEl.className='switch' + (item.active ? ' on' : '');
      switchEl.setAttribute('role','switch'); switchEl.setAttribute('aria-checked', item.active ? 'true' : 'false');
      switchEl.addEventListener('click', ()=>{ item.active = !item.active; switchEl.classList.toggle('on', item.active); switchEl.setAttribute('aria-checked', item.active ? 'true' : 'false'); save(); normalizeOrder(true); normalizeOrder(false); render(); updateSum(); });
      const label = document.createElement('div'); label.className='label'; label.textContent = item.active ? 'active' : 'inactive';
      activeWrap.append(label, switchEl);

      // selection checkbox only in edit mode
      const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.className='checkbox' + (editMode ? ' show' : '');
      checkbox.checked = !!item.selected;
      checkbox.addEventListener('change', ()=>{ item.selected = checkbox.checked; save(); updateBulkUI(); });

      // compose
      if(editMode){ row.append(checkbox); }
      row.append(drag, title, hours, activeWrap);

      attachDrag(row, drag, item.active);
      return row;
    };

    active.forEach(it=> listA.append(buildRow(it)));
    inactive.forEach(it=> listI.append(buildRow(it)));
    updateSum();
    updateBulkUI();
  }

  function updateBulkUI(){
    const selected = items.filter(x=>x.selected);
    selCountEl.textContent = String(selected.length);
    bulkBar.classList.toggle('show', editMode);
    bulkEditBtn.disabled = selected.length !== 1;
    bulkDeleteBtn.disabled = selected.length === 0;
  }

  function formatHours(n){
    if(!Number.isFinite(n)) return '0';
    return (Math.round(n * 10) / 10).toLocaleString(undefined, { maximumFractionDigits: 1 }) + ' h';
  }

  function updateSum(){
    const active = items.filter(x=>x.active);
    const sum = active.reduce((acc,x)=> acc + (Number.isFinite(x.hours)? x.hours : 0), 0);
    activeCountEl.textContent = String(active.length);
    sumEl.textContent = (Math.round(sum * 10) / 10).toLocaleString(undefined, { maximumFractionDigits: 1 }) + ' h';
    updateETA(sum);
  }

  function updateETA(sum){
    const raw = (dailyIn.value||'').toString().replace(',', '.');
    const d = parseFloat(raw);
    if(!Number.isFinite(d) || d <= 0){ etaText.textContent = '≈ 0 days'; return; }
    const days = sum / d;
    const rounded = Math.ceil(days * 10) / 10;
    etaText.textContent = '≈ ' + rounded.toLocaleString(undefined, { maximumFractionDigits: 1 }) + ' days';
  }

  function add(){
    const t = (titleIn.value||'').trim();
    const raw = (hoursIn.value||'').toString().replace(',', '.')
    const h = parseFloat(raw);
    if(!t){ titleIn.focus(); return; }
    const hours = Number.isFinite(h) && h >= 0 ? h : 0;
    const groupArr = items.filter(x=>x.active).sort((a,b)=> (a.order??0)-(b.order??0));
    const nextOrder = groupArr.length ? (groupArr[groupArr.length-1].order + 1) : 0;
    items.push({ id: uid(), title: t, hours, active: true, selected: false, order: nextOrder });
    titleIn.value=''; hoursIn.value='';
    save(); render();
  }

  function removeSelected(){
    items = items.filter(x=>!x.selected);
    save(); render();
  }

  function editSelected(){
    const item = items.find(x=>x.selected);
    if(!item) return;
    const container = item.active ? listA : listI;
    const row = container.querySelector('.row[data-id="'+item.id+'"]');
    if(!row) return;
    startEditTitle(row.querySelector('.title'), item);
    startEditHours(row.querySelector('.hours'), item);
  }

  function startEditTitle(el, item){
    const input = document.createElement('input'); input.type='text'; input.value=item.title; input.className='title'; input.style.padding='8px'; input.style.borderRadius='10px'; input.style.border='1px solid #2a3156'; input.style.background='#0f1433'; input.style.color='var(--ink)';
    const finish = ()=>{ item.title = input.value.trim()||item.title; save(); render(); };
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') finish(); if(e.key==='Escape') render(); });
    input.addEventListener('blur', finish);
    el.replaceWith(input); input.focus(); input.select();
  }

  function startEditHours(el, item){
    const input = document.createElement('input'); input.type='number'; input.step='0.5'; input.min='0'; input.value=String(item.hours);
    input.className='hours'; input.style.padding='6px'; input.style.borderRadius='10px'; input.style.border='1px solid #2a3156'; input.style.background='#0f1433'; input.style.color='var(--ink)'; input.style.textAlign='right';
    const finish = ()=>{ const v = parseFloat((input.value||'').replace(',', '.')); if(Number.isFinite(v) && v>=0) item.hours=v; save(); render(); };
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') finish(); if(e.key==='Escape') render(); });
    input.addEventListener('blur', finish);
    el.replaceWith(input); input.focus(); input.select();
  }

  function attachDrag(row, handle, isActiveGroup){
    let dragging = null, startY = 0, placeholder = null, container = isActiveGroup ? listA : listI;

    const onPointerMove = (e)=>{
      if(!dragging) return;
      e.preventDefault();
      const y = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      const dy = y - startY;
      dragging.style.transform = 'translateY(' + dy + 'px)';
      const rows = Array.from(container.querySelectorAll('.row'));
      const rect = dragging.getBoundingClientRect();
      const midY = rect.top + rect.height/2 + dy;
      let target = null;
      for(const r of rows){
        if(r===dragging) continue;
        const rr = r.getBoundingClientRect();
        if(midY < rr.top + rr.height/2){ target = r; break; }
      }
      if(target){
        container.insertBefore(placeholder, target);
      } else {
        container.appendChild(placeholder);
      }
    };

    const endDrag = ()=>{
      if(!dragging) return;
      dragging.classList.remove('dragging');
      dragging.style.position=''; dragging.style.zIndex=''; dragging.style.width=''; dragging.style.left=''; dragging.style.transform='';
      placeholder.replaceWith(dragging);
      placeholder = null;
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', endDrag);
      document.removeEventListener('pointercancel', endDrag);
      const ids = Array.from(container.querySelectorAll('.row')).map(r=> r.dataset.id);
      const groupItems = items.filter(x=>x.active===isActiveGroup);
      ids.forEach((id, idx)=>{
        const it = groupItems.find(g=>g.id===id);
        if(it) it.order = idx;
      });
      save(); render();
    };

    const startDrag = (e)=>{
      e.preventDefault();
      container = (row.classList.contains('active') ? listA : listI);
      isActiveGroup = row.classList.contains('active');
      startY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
      dragging = row;
      placeholder = document.createElement('div'); placeholder.className='placeholder'; placeholder.style.height = row.offsetHeight + 'px';
      row.parentElement.insertBefore(placeholder, row);
      const rect = row.getBoundingClientRect();
      row.classList.add('dragging');
      row.style.position='relative';
      row.style.zIndex='10';
      row.style.width = rect.width + 'px';
      row.style.left = '0px';
      document.addEventListener('pointermove', onPointerMove, {passive:false});
      document.addEventListener('pointerup', endDrag);
      document.addEventListener('pointercancel', endDrag);
    };

    handle.addEventListener('pointerdown', startDrag);
    handle.addEventListener('touchmove', (e)=>{ if(dragging) e.preventDefault(); }, {passive:false});
  }

  function exportData(){
    const data = { version: APP_VERSION, exportedAt: new Date().toISOString(), items, daily: dailyIn.value || '' };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'games-bucket-backup.json';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function importData(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = JSON.parse(String(e.target.result||'{}'));
        if(Array.isArray(data.items)){
          items = data.items.map((x,idx) => ({ id: x.id || (Math.random()+''+Date.now()), title: x.title||'', hours: Number(x.hours)||0, active: !!x.active, selected:false, order: Number.isFinite(x.order)? x.order : idx }));
        }
        if(data.daily !== undefined){ dailyIn.value = String(data.daily); localStorage.setItem(DAILY_KEY, dailyIn.value); }
        save(); render(); updateSum();
        alert('Import successful.');
      }catch(err){ alert('Import failed: ' + err); }
    };
    reader.readAsText(file);
  }

  editToggle.addEventListener('click', ()=>{
    editMode = !editMode;
    editToggle.textContent = editMode ? 'Done' : 'Edit';
    if(!editMode){ items.forEach(x=> x.selected = false); }
    save();
    render();
  });

  addBtn.addEventListener('click', add);
  titleIn.addEventListener('keydown', e=>{ if(e.key==='Enter') add(); });
  hoursIn.addEventListener('keydown', e=>{ if(e.key==='Enter') add(); });
  document.getElementById('bulkDeleteBtn').addEventListener('click', removeSelected);
  document.getElementById('bulkEditBtn').addEventListener('click', editSelected);
  exportBtn.addEventListener('click', exportData);
  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', ()=>{ if(importFile.files && importFile.files[0]) importData(importFile.files[0]); });

  function saveDaily(){ localStorage.setItem(DAILY_KEY, dailyIn.value || ''); }
  dailyIn.addEventListener('input', ()=>{ saveDaily(); updateSum(); });

  try { const v = localStorage.getItem(DAILY_KEY); if(v!==null) dailyIn.value = v; } catch(e) {}
  load(); normalizeOrder(true); normalizeOrder(false); save(); render();
})();
</script>
</body>
</html>
